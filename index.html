<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D&D Legend Vault 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Spectral:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --dnd-red: #8b0000; --accent-gold: #d4af37; --deep-bg: #0d0d0d; }
        body { background-color: var(--deep-bg); color: #e0e0e0; font-family: 'Spectral', serif; background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        h1, h2, h3, .font-fantasy { font-family: 'MedievalSharp', cursive; letter-spacing: 1px; }
        .stat-card { background: linear-gradient(145deg, #1e1e1e, #141414); border: 1px solid #333; border-top: 2px solid var(--accent-gold); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        input, textarea, select { background: rgba(0,0,0,0.6) !important; border: 1px solid #444 !important; color: #fff !important; border-radius: 4px; outline: none; }
        .slot-dot { width: 12px; height: 12px; border: 2px solid #444; border-radius: 50%; cursor: pointer; }
        .slot-dot.active { background: #3b82f6; box-shadow: 0 0 8px #3b82f6; border-color: #fff; }
        .btn-gold { background: linear-gradient(to bottom, #d4af37, #aa850b); color: #000; font-weight: bold; text-transform: uppercase; border-radius: 4px; transition: 0.2s; }
        .gold-text { color: var(--accent-gold); }
        .desc-box { background: rgba(0,0,0,0.4); border-left: 2px solid var(--accent-gold); padding: 8px; margin-top: 5px; font-size: 11px; color: #aaa; font-style: italic; }
    </style>
</head>
<body class="p-2 md:p-6">

    <header class="max-w-[1400px] mx-auto mb-6 flex flex-wrap justify-between items-center bg-[#111] p-4 rounded-lg border-b-2 border-gold gap-4 shadow-2xl">
        <div class="flex items-center gap-4">
            <select id="char-selector" onchange="switchCharacter()" class="bg-transparent text-xl font-bold gold-text cursor-pointer border-none"></select>
            <button onclick="createNewCharacter()" class="text-[10px] bg-white/5 px-2 py-1 rounded hover:bg-white/10 text-gray-400">+ Новий</button>
        </div>
        
        <div class="flex flex-wrap gap-4 items-center bg-black/60 px-4 py-2 rounded-lg border border-gray-800">
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-500 uppercase font-bold">Cloud Key:</span>
                <input type="text" id="cloud-key" placeholder="Твій ключ..." class="w-24 text-[10px] px-2 py-1 bg-black/40 border border-gray-700 rounded" oninput="saveKey()">
            </div>
            <div class="w-[1px] h-4 bg-gray-700"></div>
            <button id="cloud-save-btn" onclick="syncToCloud()" class="text-blue-400 hover:text-blue-300 transition text-lg"><i class="fa-solid fa-cloud-arrow-up"></i></button>
            <button id="cloud-load-btn" onclick="loadFromCloud()" class="text-green-400 hover:text-green-300 transition text-lg"><i class="fa-solid fa-cloud-arrow-down"></i></button>
            <div class="w-[1px] h-4 bg-gray-700"></div>
            <button onclick="exportCharacter()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-download"></i></button>
            <label class="text-gray-400 hover:text-white cursor-pointer"><i class="fa-solid fa-upload"></i><input type="file" class="hidden" onchange="importCharacter(event)"></label>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">
        
        <section class="space-y-6">
            <div class="stat-card p-5">
                <input type="text" id="char-name" oninput="update('name')" class="w-full text-2xl font-bold bg-transparent border-none text-white mb-1" placeholder="Ім'я">
                <div class="flex justify-between items-center text-xs">
                    <input type="text" id="char-classLvl" oninput="update('classLvl')" class="gold-text font-bold bg-transparent border-none uppercase" placeholder="Клас/Рівень">
                    <div class="text-gray-500">PROF: +<input type="number" id="char-prof" oninput="update('prof')" class="w-8 bg-transparent text-center border-none"></div>
                </div>
            </div>
            <div id="stats-container" class="space-y-3"></div>
            <div class="stat-card p-4">
                <h3 class="text-xs font-bold gold-text uppercase mb-3 italic">Навички</h3>
                <div id="skills-list" class="space-y-1.5 max-h-[350px] overflow-y-auto text-[11px]"></div>
            </div>
        </section>

        <section class="space-y-6">
            <div class="grid grid-cols-3 gap-4">
                <div class="stat-card p-3 text-center border-t-2 border-blue-500"><div class="text-[8px] text-gray-500 font-bold">AC</div><input type="number" id="char-ac" oninput="update('ac')" class="w-full text-center text-3xl font-fantasy bg-transparent border-none"></div>
                <div class="stat-card p-3 text-center border-t-2 border-yellow-500"><div class="text-[8px] text-gray-500 font-bold">INIT</div><input type="number" id="char-init" oninput="update('init')" class="w-full text-center text-3xl font-fantasy bg-transparent border-none"></div>
                <div class="stat-card p-3 text-center border-t-2 border-green-500"><div class="text-[8px] text-gray-500 font-bold">SPD</div><input type="text" id="char-speed" oninput="update('speed')" class="w-full text-center text-2xl font-fantasy bg-transparent border-none"></div>
            </div>
            <div class="stat-card p-5">
                <div class="flex justify-between items-center mb-2"><span class="text-sm font-bold uppercase gold-text">HP</span><span class="text-lg font-fantasy text-green-500"><span id="cur-hp">0</span> / <input type="number" id="char-maxHP" oninput="update('maxHP')" class="w-12 text-center bg-transparent border-none"></span></div>
                <div class="h-2 bg-black rounded-full mb-4"><div id="hp-bar" class="h-full bg-green-600 rounded-full transition-all duration-500"></div></div>
                <div class="flex gap-2">
                    <input type="number" id="hp-mod" placeholder="+/-" class="w-1/3 text-center text-sm">
                    <button onclick="changeHP(-1)" class="flex-1 bg-red-900/30 text-red-500 rounded text-[9px] font-bold">DAM</button>
                    <button onclick="changeHP(1)" class="flex-1 bg-green-900/30 text-green-500 rounded text-[9px] font-bold">HEAL</button>
                </div>
            </div>
            <div class="stat-card p-4 border-t-2 border-blue-900">
                <h3 class="text-xs font-bold gold-text uppercase mb-4">Комірки магії</h3>
                <div id="slots-container" class="grid grid-cols-3 gap-3"></div>
                <button onclick="longRest()" class="w-full mt-5 py-1 bg-black/40 border border-gray-800 rounded uppercase text-[9px] gold-text">Відпочинок</button>
            </div>
        </section>

        <section class="space-y-6">
            <div class="stat-card p-4 border-t-2 border-red-900">
                <h3 class="text-xs font-bold text-red-600 uppercase mb-3 italic">Арсенал</h3>
                <div id="weapons-list" class="space-y-2 mb-3"></div>
                <div class="bg-black/50 p-3 rounded space-y-2 border border-gray-800 text-[11px]">
                    <div class="flex gap-1"><input type="text" id="wp-n" placeholder="Назва..." class="flex-1 px-2 py-1"><input type="text" id="wp-a" placeholder="+Атк" class="w-12 text-center"></div>
                    <textarea id="wp-d" placeholder="Опис шкоди..." class="w-full h-12 p-2"></textarea>
                    <button onclick="addWp()" class="w-full btn-gold py-1">Додати атаку</button>
                </div>
            </div>
            <div class="stat-card p-4 border-t-2 border-purple-800">
                <h3 class="text-xs font-bold text-purple-400 uppercase mb-3 italic">Заклинання</h3>
                <div id="spell-list" class="max-h-80 overflow-y-auto space-y-1"></div>
                <div class="mt-4 bg-black/50 p-3 rounded space-y-2 border border-gray-800 text-[11px]">
                    <div class="flex gap-1"><input type="text" id="sp-n" placeholder="Назва..." class="flex-1 px-2 py-1"><select id="sp-l" class="w-14"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select></div>
                    <textarea id="sp-d" placeholder="Опис магії..." class="w-full h-12 p-2"></textarea>
                    <button onclick="addSpell()" class="w-full bg-purple-900 text-purple-100 py-1 rounded">Вивчити</button>
                </div>
            </div>
        </section>

        <section class="space-y-6">
            <div class="stat-card p-4 border-t-2 border-yellow-700">
                <h3 class="text-xs font-bold text-yellow-600 uppercase mb-3">Рюкзак</h3>
                <div id="inv-list" class="space-y-1.5 max-h-48 overflow-y-auto mb-3 text-[11px]"></div>
                <div class="bg-black/50 p-3 rounded border border-gray-800 space-y-2 text-[11px]">
                    <input type="text" id="it-n" placeholder="Річ..." class="w-full px-2 py-1">
                    <textarea id="it-d" placeholder="Властивості..." class="w-full h-12 p-2"></textarea>
                    <button onclick="addIt()" class="w-full bg-yellow-900 text-yellow-500 py-1 rounded">Покласти</button>
                </div>
            </div>
            <div class="stat-card p-4 flex-1 flex flex-col min-h-[300px]">
                <h3 class="text-xs font-bold gold-text uppercase mb-2">Нотатки</h3>
                <textarea id="char-notes" oninput="update('notes')" class="flex-1 w-full bg-transparent border-none text-[12px] p-0 resize-none outline-none"></textarea>
            </div>
        </section>
    </main>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzK2BLgQI0PV4ijIAkXs7z7pm0S3_W05x7mXQMa7ljaZQb9VpRwOPH6S1cJi3evUvhROg/exec";

        const skillList = ["Атлетика (STR)", "Акробатика (DEX)", "Скритність (DEX)", "Ловкість рук (DEX)", "Аналіз (INT)", "Історія (INT)", "Магія (INT)", "Природа (INT)", "Релігія (INT)", "Уважність (WIS)", "Виживання (WIS)", "Медицина (WIS)", "Прозорливість (WIS)", "Тварини (WIS)", "Виступ (CHA)", "Залякування (CHA)", "Обман (CHA)", "Переконання (CHA)"];
        const maxSlots = [4, 3, 3, 3, 3, 2, 2, 1, 1]; 

        const template = {
            name: "Герой", classLvl: "Рівень 1", stats: { STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10 },
            ac: 10, init: 0, speed: "30", curHP: 10, maxHP: 10, prof: 2,
            inventory: [], spells: [], weapons: [], notes: "",
            slots: [0,0,0,0,0,0,0,0,0]
        };

        let chars = JSON.parse(localStorage.getItem('dnd_legend_multi')) || [{...template}];
        let idx = parseInt(localStorage.getItem('dnd_legend_idx')) || 0;

        window.onload = () => {
            document.getElementById('cloud-key').value = localStorage.getItem('dnd_cloud_key') || '';
            load();
        };

        function saveKey() { localStorage.setItem('dnd_cloud_key', document.getElementById('cloud-key').value); }

        async function syncToCloud() {
            const key = document.getElementById('cloud-key').value;
            if (!key) return alert("Введи Cloud Key!");
            const btn = document.getElementById('cloud-save-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ key: key, chars: chars })
                });
                alert("Дані збережено для ключа: " + key);
            } catch (e) { alert("Помилка."); }
            finally { btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>'; }
        }

        function loadFromCloud() {
    const key = document.getElementById('cloud-key').value;
    if (!key) return alert("Введи ключ!");
    
    const btn = document.getElementById('cloud-load-btn');
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

    const cbName = 'cb_' + Date.now();
    
    // Створюємо таймер на 5 секунд
    const timeout = setTimeout(() => {
        cleanup();
        alert("Час очікування вичерпано. Перевір посилання або інтернет.");
    }, 5000);

    window[cbName] = function(data) {
        clearTimeout(timeout); // Скасовуємо таймер, якщо дані прийшли
        if (data && Array.isArray(data) && data.length > 0) {
            chars = data;
            idx = 0;
            save();
            load();
            alert("Герої прибули з хмари!");
        } else {
            alert("За цим ключем порожньо.");
        }
        cleanup();
    };

    function cleanup() {
        delete window[cbName];
        const old = document.getElementById('jsonp');
        if (old) old.remove();
        btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-down"></i>';
    }

    const script = document.createElement('script');
    script.id = 'jsonp';
    // Додаємо випадкове число, щоб уникнути кешування браузером
    script.src = GOOGLE_SCRIPT_URL + "?key=" + encodeURIComponent(key) + "&callback=" + cbName + "&v=" + Date.now();
    
    script.onerror = () => {
        clearTimeout(timeout);
        alert("Помилка скрипта. Перевір Deployment URL.");
        cleanup();
    };
    
    document.body.appendChild(script);
}

        function load() {
            if (!chars[idx]) idx = 0;
            const c = chars[idx];
            ['name','classLvl','prof','ac','init','speed','maxHP','notes'].forEach(f => {
                const el = document.getElementById(`char-${f}`);
                if (el) el.value = c[f] !== undefined ? c[f] : "";
            });
            renderAll();
        }

        function renderAll() {
            renderStats(); renderSkills(); renderHP(); renderInv(); renderSpells(); renderWeapons(); renderSlots(); renderSelector();
        }

        function update(f) {
            const el = document.getElementById(`char-${f}`);
            chars[idx][f] = (el.type === 'number') ? parseInt(el.value) || 0 : el.value;
            if (f === 'name') renderSelector();
            if (f === 'maxHP') renderHP();
            save();
        }

        function save() {
            localStorage.setItem('dnd_legend_multi', JSON.stringify(chars));
            localStorage.setItem('dnd_legend_idx', idx);
        }

        function renderStats() {
            const cont = document.getElementById('stats-container');
            cont.innerHTML = Object.entries(chars[idx].stats).map(([k, v]) => {
                const mod = Math.floor((v-10)/2);
                return `<div class="stat-card p-3 flex justify-between items-center px-4 border-l-4 border-gold">
                    <span class="text-[10px] font-bold text-gray-500 uppercase">${k}</span>
                    <input type="number" value="${v}" oninput="uStat('${k}',this.value)" class="w-10 text-center text-xl font-fantasy bg-transparent border-none">
                    <span class="text-sm gold-text font-bold w-8 text-right italic">${mod >= 0 ? '+' : ''}${mod}</span>
                </div>`;
            }).join('');
        }
        function uStat(k, v) { chars[idx].stats[k] = parseInt(v) || 0; renderStats(); renderSkills(); save(); }

        function renderSkills() {
            document.getElementById('skills-list').innerHTML = skillList.map(s => {
                const statKey = s.match(/\((.*?)\)/)[1];
                const mod = Math.floor((chars[idx].stats[statKey]-10)/2);
                return `<div class="flex justify-between items-center border-b border-white/5 py-1"><span>${s.split(' (')[0]}</span><span class="gold-text">${mod >= 0 ? '+' : ''}${mod}</span></div>`;
            }).join('');
        }

        function renderHP() {
            const c = chars[idx];
            const p = Math.min(100, (c.curHP / (c.maxHP || 1)) * 100);
            document.getElementById('hp-bar').style.width = p + '%';
            document.getElementById('cur-hp').innerText = c.curHP;
        }
        function changeHP(m) {
            const v = parseInt(document.getElementById('hp-mod').value) || 0;
            chars[idx].curHP = m > 0 ? Math.min(chars[idx].maxHP, chars[idx].curHP + v) : Math.max(0, chars[idx].curHP - v);
            document.getElementById('hp-mod').value = ''; renderHP(); save();
        }

        function renderSlots() {
            const cont = document.getElementById('slots-container');
            cont.innerHTML = maxSlots.map((max, lvlIdx) => `
                <div class="bg-black/30 p-2 rounded text-center border border-gray-900">
                    <div class="text-[8px] text-gray-500 mb-1">LVL ${lvlIdx+1}</div>
                    <div class="flex justify-center gap-1">${Array.from({length: max}, (_, i) => `
                        <div onclick="tglSlot(${lvlIdx}, ${i})" class="slot-dot ${i < (chars[idx].slots[lvlIdx] || 0) ? 'active' : ''}"></div>
                    `).join('')}</div>
                </div>`).join('');
        }
        function tglSlot(lvl, i) { chars[idx].slots[lvl] = (chars[idx].slots[lvl] === i + 1) ? i : i + 1; renderSlots(); save(); }

        function addWp() {
            const n = document.getElementById('wp-n').value, a = document.getElementById('wp-a').value, d = document.getElementById('wp-d').value;
            if(n) { chars[idx].weapons.push({name:n, atk:a, desc:d}); document.getElementById('wp-n').value=''; document.getElementById('wp-a').value=''; document.getElementById('wp-d').value=''; renderWeapons(); save(); }
        }
        function renderWeapons() {
            document.getElementById('weapons-list').innerHTML = chars[idx].weapons.map((w, i) => `
                <div class="bg-black/40 p-2 rounded border border-red-900/20 text-[11px]">
                    <div class="flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span><b class="text-red-500">${w.atk}</b> ${w.name}</span>
                        <button onclick="chars[idx].weapons.splice(${i},1); renderWeapons(); save()" class="text-gray-700">✕</button>
                    </div>
                    <div class="hidden desc-box">${w.desc || 'Немає опису...'}</div>
                </div>`).join('');
        }

        function addSpell() {
            const n = document.getElementById('sp-n').value, l = parseInt(document.getElementById('sp-l').value), d = document.getElementById('sp-d').value;
            if(n) { chars[idx].spells.push({name:n, lvl:l, desc:d}); document.getElementById('sp-n').value=''; document.getElementById('sp-d').value=''; renderSpells(); save(); }
        }
        function renderSpells() {
            const sorted = [...chars[idx].spells].sort((a,b) => a.lvl - b.lvl);
            let html = '', lastLvl = -1;
            sorted.forEach(s => {
                if(s.lvl !== lastLvl) {
                    html += `<div class="text-[9px] gold-text font-bold uppercase mt-3 mb-1 border-b border-purple-900/30">${s.lvl==0?'Cantrips':'Level '+s.lvl}</div>`;
                    lastLvl = s.lvl;
                }
                const oIdx = chars[idx].spells.indexOf(s);
                html += `<div class="p-1 border-b border-white/5 text-[11px]">
                    <div class="flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span>${s.name}</span>
                        <button onclick="chars[idx].spells.splice(${oIdx},1); renderSpells(); save()" class="text-gray-700">✕</button>
                    </div>
                    <div class="hidden desc-box">${s.desc || 'Немає опису...'}</div>
                </div>`;
            });
            document.getElementById('spell-list').innerHTML = html;
        }

        function addIt() {
            const n = document.getElementById('it-n').value, d = document.getElementById('it-d').value;
            if(n) { chars[idx].inventory.push({name:n, desc:d}); document.getElementById('it-n').value=''; document.getElementById('it-d').value=''; renderInv(); save(); }
        }
        function renderInv() {
            document.getElementById('inv-list').innerHTML = chars[idx].inventory.map((it, i) => `
                <div class="py-1 border-b border-white/5">
                    <div class="flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span>${it.name}</span>
                        <button onclick="chars[idx].inventory.splice(${i},1); renderInv(); save()" class="text-gray-700">✕</button>
                    </div>
                    <div class="hidden desc-box">${it.desc || 'Порожньо...'}</div>
                </div>`).join('');
        }

        function longRest() { if(confirm("Відпочити?")) { chars[idx].curHP = chars[idx].maxHP; chars[idx].slots = [0,0,0,0,0,0,0,0,0]; renderAll(); save(); } }
        function renderSelector() { document.getElementById('char-selector').innerHTML = chars.map((c, i) => `<option value="${i}" ${i==idx?'selected':''}>${c.name}</option>`).join(''); }
        function switchCharacter() { idx = parseInt(document.getElementById('char-selector').value); load(); save(); }
        function createNewCharacter() { chars.push(JSON.parse(JSON.stringify(template))); idx = chars.length - 1; load(); save(); }
        function exportCharacter() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chars)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "chars.json"); dl.click(); }
        function importCharacter(ev) { const reader = new FileReader(); reader.onload = (e) => { chars = JSON.parse(e.target.result); idx = 0; save(); load(); }; reader.readAsText(ev.target.files[0]); }
    </script>
</body>
</html>


